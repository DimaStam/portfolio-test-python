stages:
  - install
  - Zegarownia
  - Fabryka
  - Watchard
  - Hodinkovna-CZ
  - Hodinkovna-SK
  - Eceasuri
  - Eorak
  - Send-report

variables:
  HEADLESS: "true"

cache:
  paths:
    - .cache
    - venv/

before_script:
  - apt-get update && apt-get install -y python3-venv
  - python -V
  - python -m venv venv
  - source venv/bin/activate
  - pip install -r requirements.txt

default:
  image: mcr.microsoft.com/playwright/python:v1.44.0-jammy
  tags:
    - superpharm
  artifacts:
    when: always
    expire_in: 3 DAYS
    paths:
      - screenshots/
      - /allure-results

.pipeline-branch-model:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: always
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: manual
  allow_failure: true

.pipeline-test:
  extends: .pipeline-branch-model
  script:
    - source venv/bin/activate
    - pytest --TestPath=$STORE_TEST_PATH --env=$ENVIRONMENT --alluredir=allure_results

install-dependencies:
  stage: install
  script:
    - pip install pytest playwright
    - playwright install

Zegarownia-orders:
  extends: .pipeline-test
  stage: Zegarownia
  variables:
    STORE_TEST_PATH: "tests/Zegarownia/Orders/GuestUser/"

Fabryka-orders:
  extends: .pipeline-test
  stage: Fabryka
  variables:
    STORE_TEST_PATH: "tests/Fabrykazegarkow/Orders/GuestUser/"

Hodinkovna-CZ-orders:
  extends: .pipeline-test
  stage: Hodinkovna-CZ
  variables:
    STORE_TEST_PATH: "tests/HodinkovnaCZ/Orders/GuestUser/"

Hodinkovna-SK-orders:
  extends: .pipeline-test
  stage: Hodinkovna-SK
  variables:
    STORE_TEST_PATH: "tests/HodinkovnaSK/Orders/GuestUser/"

Eceasuri-orders:
  extends: .pipeline-test
  stage: Eceasuri
  variables:
    STORE_TEST_PATH: "tests/Eceasuri/Orders/GuestUser/"

Eorak-orders:
  extends: .pipeline-test
  stage: Eorak
  variables:
    STORE_TEST_PATH: "tests/Eorak/Orders/GuestUser/"

Submit-finished-report:
  stage: Send-report
  before_script:
    - date
    - apt-get update && apt-get install -y wget jq
  script:
    - chmod +x ./allure-server/allure-push.sh
    - ./allure-server/allure-push.sh ${CI_PIPELINE_ID} 
  dependencies:
    - Zegarownia-orders
    - Fabryka-orders
    - Hodinkovna-CZ-orders
    - Hodinkovna-SK-orders
    - Eceasuri-orders
    - Eorak-orders
